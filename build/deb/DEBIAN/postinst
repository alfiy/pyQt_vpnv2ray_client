#!/bin/bash
set -e

PKG_NAME="ov2n"
PKG_PATH="/usr/local/lib/${PKG_NAME}"
BIN_PATH="/usr/local/bin/${PKG_NAME}"

echo "Setting up ${PKG_NAME}..."
echo ""

# Step 1: Verify launcher exists
if [ ! -f "${BIN_PATH}" ]; then
    echo "ERROR: Launcher script not found at ${BIN_PATH}"
    exit 1
fi
echo "✓ Launcher script verified"

# Step 2: Make launcher executable
chmod +x "${BIN_PATH}" 2>/dev/null || {
    echo "ERROR: Failed to make launcher executable"
    exit 1
}
echo "✓ Launcher script is executable"

# Step 3: Verify package path exists
if [ ! -d "${PKG_PATH}" ]; then
    echo "ERROR: Package directory not found at ${PKG_PATH}"
    exit 1
fi
echo "✓ Package directory verified"

# Step 4: Create convenient symlink
if [ ! -d "/opt" ]; then
    mkdir -p /opt
fi
ln -sf ${PKG_PATH} /opt/${PKG_NAME} 2>/dev/null || true
echo "✓ Symlink created at /opt/${PKG_NAME}"

# Step 5: Install polkit files if present
if [ -d "${PKG_PATH}/polkit" ]; then
    echo "✓ Configuring PolicyKit integration..."
    
    if [ -f "${PKG_PATH}/polkit"/*.policy ]; then
        cp ${PKG_PATH}/polkit/*.policy /usr/share/polkit-1/actions/ 2>/dev/null || true
        echo "  ✓ PolicyKit policies installed"
    fi
    
    # Copy helper scripts
    for script in ${PKG_PATH}/polkit/*.py; do
        if [ -f "$script" ]; then
            cp "$script" /usr/local/bin/ 2>/dev/null || true
            chmod +x /usr/local/bin/$(basename $script) 2>/dev/null || true
        fi
    done
    echo "  ✓ Helper scripts installed"
fi

# Step 6: Update desktop database
echo "✓ Updating desktop database..."
update-desktop-database /usr/share/applications 2>/dev/null || true

# Step 7: 验证 PyQt5 安装 (不再通过 pip 安装)
echo "✓ Verifying PyQt5 installation..."
if python3 -c "import PyQt5.QtWidgets" 2>/dev/null; then
    echo "  ✓ PyQt5 is properly installed"
else
    echo "  ⚠ Warning: PyQt5 not found!"
    echo "    Please install: sudo apt install python3-pyqt5"
fi

echo ""
echo "╔════════════════════════════════════════╗"
echo "║   ov2n Installation Completed!         ║"
echo "╠════════════════════════════════════════╣"
echo "║  Start the application:                ║"
echo "║    $ ov2n                              ║"
echo "║                                        ║"
echo "║  Or search for 'ov2n' in your menu     ║"
echo "╚════════════════════════════════════════╝"
echo ""

exit 0
